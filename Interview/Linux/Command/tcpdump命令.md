`tcpdump`是一个强大的网络数据包捕获工具,它可以用来截获网络传输的数据包, 并根据用户指定的规则进行过滤和分析。下面我们来详细介绍一下`tcpdump`命令的用法:

1. **基本用法**

```
tcpdump [选项] [过滤表达式]
```

- 不加任何选项和过滤表达式,`tcpdump`会监听第一个网卡接口,并捕获所有经过该网卡的数据包。
- `-i 网卡名称` 指定要监听的网卡,如`eth0`、`wlan0`等。
- `-n` 直接显示IP地址和端口号,而不是将其转换为域名和服务名。
- `-nn` 禁止所有主机名和端口名的转换。
- `-X` 以十六进制和ASCII码同时显示数据包的内容。
- `-XX` 与`-X`类似,但是输出的是用c语言风格的字符串表示。
- `-S` 打印出绝对的序列号,而不是相对序列号。
- `-e` 获取ethernet头部信息,如MAC地址等。
- `-q` 少于输出信息(安静模式)。
- `-c 数目` 捕获指定数目的数据包后就自动退出。

2. **过滤表达式**

过滤表达式允许你只抓取感兴趣的网络数据包,从而减少不必要的输出。它们由一个或多个基本primitives组合而成。

常用的过滤表达式有:

- `host 192.168.1.1` 捕获到达或离开指定主机的数据包。
- `net 192.168.1.0/24` 捕获指定网段的数据包。
- `port 80` 捕获指定端口号的数据包。
- `tcp`、`udp`、`icmp` 捕获指定协议的数据包。
- `src`、`dst` 根据源或目的地址过滤。
- `and`、`or`、`not` 对过滤条件进行逻辑运算。

例如,要捕获所有通过3306端口(MySQL服务端口)的TCP流量,可以使用:

```
tcpdump -i any port 3306
```

3. **输出文件**

如果想将捕获的数据包保存到文件中,可以使用`-w`选项:

```
tcpdump -w captured_data.pcap
```

保存的文件格式是`pcap`,可以使用Wireshark等工具进行离线分析。

4. **从文件读取**

如果想从已保存的`pcap`文件中读取数据包,可以使用`-r`选项:

```
tcpdump -r captured_data.pcap
```

总的来说,`tcpdump`是一个功能十分强大的网络数据包捕获和分析工具,能够满足各种网络故障诊断和安全审计的需求。通过对过滤表达式的灵活组合,可以快速锁定感兴趣的网络流量。掌握它的用法对于分析和排查网络问题非常有帮助。